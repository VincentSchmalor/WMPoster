---
title: "WM-Plakat: A new hope"
author: "Vincent Schmalor"
date: "27.12.2019"
output: html_document
---

```{r Setup und Funktionen, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::knit_meta(class=NULL, clean = TRUE)
library(mosaic)
library(corrplot)
library(kableExtra)
library(Hmisc)
options(scipen = 999)
set.seed = 2020
DST.raw <- read.csv2("sources/Trainingsdaten.csv")

flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
}
```

# Einleitung
Platzhalter für eine schöne Einleitung.

# Vorbereitung des Datensets
1. Spalten benennen
```{r Spalten benennen}
colnames(DST.raw) <- c("Beratung", "Angebote", "Bequemlichkeit", "Einkaufsatmosphaere", "Marken", "GPM", "Naehe", "Partner", "Eltern", "Verwandte", "Kommilitonen", "Kinder", "Freunde", "Arbeitskollegen", "GemNutz", "Alter", "Geschlecht", "Budget")
```

2. Resample in mehrere Datasets
```{r Resamples erstellen}
DS.RS1 <- resample(DST.raw)
DS.RS2 <- resample(DST.raw)
DS.RS3 <- resample(DST.raw)
```

3. Bereinigung um Ausreißer in neues Datenset
```{r DS bereinigen}
DST.clean <- filter(DST.raw, Budget > 30)
OL.DS.raw <- boxplot.stats(DST.clean$Budget)$out
paste("Ausreißer: ", paste(OL.DS.raw, collapse=", "))
DST.clean <- DST.clean %>% filter(!(Budget %in% OL.DS.raw))
```

4. Hizufügen der Kennzahlen Geschenkanzahl und Wertschätzung
```{r Geschenkanzahl und Wertschätzung}
DST.extra <- mutate(DST.clean, GesAnz = Partner + Eltern + Verwandte + Kommilitonen + Kinder + Freunde + Arbeitskollegen + GemNutz)
DST.extra <- mutate(DST.extra, Wertsch = Beratung + Angebote + Bequemlichkeit + Einkaufsatmosphaere + Marken + GPM + Naehe)
```

5. Zuweisung der Variablentypen in neuem Dataset
```{r Variablentypen zuweisen}
DST.num <- DST.extra
cols <- c("Beratung", "Angebote", "Bequemlichkeit", "Einkaufsatmosphaere", "Marken", "GPM", "Naehe"
          , "Geschlecht") 
DST.cat <- DST.extra
DST.cat[cols] <- lapply(DST.cat[cols], factor) #Faktorspalten setzen
```


# Explorative Datenanalyse
## Verteilungen untersuchen
1. gf_histogram

```{r Budget-Histogramm}
gf_histogram( ~ Budget, data = DST.num, binwidth = 50, center =  50)
```

2. gf_violin

```{r Budget-Violine}
gf_violin(Budget ~ 1, draw_quantiles=c(0.25,0.5,0.75), data = DST.num) %>%
gf_point(Budget ~ 1, stat = "summary", fun.y="mean", color = "red",
data = DST.num )
```

3. gf_boxplot

```{r Budget-Boxplot}
gf_boxplot(Budget ~ 1, data = DST.num)
```

## Zusammenhänge finden

```{r Korrelationsmatrix erstellen}
DST.mat <- as.matrix(data.frame(DST.num))
CMT <- rcorr(DST.mat, type = "pearson")
```

```{r R-Werte und P-Werte darstellen}
corrplot(CMT$r, type = "upper", order = "hclust", tl.col = "black", sig.level = 0.01)
corrplot(CMT$P, type = "upper", order = "hclust", tl.col = "black", sig.level = 0.01)
```

```{r R-Werte und P-Werte in Relation setzen}
CMT.tbl <- flattenCorrMatrix(CMT$r, CMT$P)
gf_point(p ~ cor, data = CMT.tbl)
```

```{r P-Werte bereinigen}
CMT.tbl.f <- filter(CMT.tbl, p < 0.03 & (row == "Budget" | column == "Budget"))
gf_point(p ~ cor, data = CMT.tbl.f)
CMT.tbl.f
```

## Zusammenhänge verdeutlichen
```{r einfache lineare Modelle erstellen}
#Einkaufsatmosphäre
lm.budget.Einkaufsatmosphaere <- lm(Budget ~ Einkaufsatmosphaere, data = DST.num)
plotModel(lm.budget.Einkaufsatmosphaere, title = "Weihnachtsbudget in Relation zur Variable Einkaufsatmosphaere")
summary(lm.budget.Einkaufsatmosphaere)

#Marken
lm.budget.Marken <- lm(Budget ~ Marken, data = DST.num)
plotModel(lm.budget.Marken, title = "Weihnachtsbudget in Relation zur Variable Marken")
summary(lm.budget.Marken)

#GPM
lm.budget.GPM <- lm(Budget ~ GPM, data = DST.num)
plotModel(lm.budget.GPM, title = "Weihnachtsbudget in Relation zur Variable Güte der Produkte und Marken")
summary(lm.budget.GPM)

#Partner
lm.budget.Partner <- lm(Budget ~ Partner, data = DST.num)
plotModel(lm.budget.Partner, title = "Weihnachtsbudget in Relation zur Variable Partner")
summary(lm.budget.Partner)

#Kinder
lm.budget.Kinder <- lm(Budget ~ Kinder, data = DST.num)
plotModel(lm.budget.Kinder, title = "Weihnachtsbudget in Relation zur Variable Kinder")
summary(lm.budget.Kinder)

#GemNutz
lm.budget.GemNutz <- lm(Budget ~ GemNutz, data = DST.num)
plotModel(lm.budget.GemNutz, title = "Weihnachtsbudget in Relation zur Variable Soziale Institutionen")

#Alter
lm.budget.alter <- lm(Budget ~ Alter, data = DST.num)
plotModel(lm.budget.alter, title = "Weihnachtsbudget in Relation zur Variable Alter")
summary(lm.budget.alter)

#GesAnz
lm.budget.GesAnz <- lm(Budget ~ GesAnz, data = DST.num)
plotModel(lm.budget.GesAnz, title = "Weihnachtsbudget in Relation zur Variable Geschenkanzahl")
summary(lm.budget.GesAnz)

#Wertschaetzung
lm.budget.Wertsch <- lm(Budget ~ Wertsch, data = DST.num)
plotModel(lm.budget.Wertsch, title = "Weihnachtsbudget in Relation zur Variable Wertschätzung")
summary(lm.budget.Wertsch)
```

## Zusammenhänge verfeinern
```{r Abhängigkeiten identifizieren}
lm.ww.Kinder.Alter <- lm(formula = Budget ~ Wertsch * Alter, data = DST.num)
plotModel(lm.ww.Kinder.Alter, color = true, title = "Untersuchung der Wechselwirkung von Kinder und Alter")
summary(lm.ww.Kinder.Alter)
```
# Modell erstellen
```{r Modell erstellen}
lm.Gesamt <- lm(
  Budget ~ 
    Alter + Einkaufsatmosphaere + Marken + GPM + Partner + Kinder + GemNutz + GesAnz + Wertsch + Alter:Kinder + 
    Einkaufsatmosphaere:Marken:GPM, data = DST.num
  )
plotModel(lm.Gesamt)
summary(lm.Gesamt)
```

