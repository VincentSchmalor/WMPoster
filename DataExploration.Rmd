---
title: "Data Exploration"
author: "Vincent Schmalor"
date: "6 12 2019"
output: html_document
#classoption: landscape
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(mosaic)
library(corrplot)
library(kableExtra)
library(reshape2)
source("http://www.sthda.com/upload/rquery_cormat.r")
test <- read.csv2("sources/Trainingsdaten.csv")
```

# Einleitung
Diese Fallstudie verwendet die Ergebnisse einer Umfrage bezüglich der Schenkgewohnheiuten und -Absichten zu Weihnachten. Anhand der Ergebnisse der einen Studie wird ein Modell erstellt, das die Ergebnisse einer anderen Stichprobe schätzt.
Dazu stehen mehrere Herangehensweisen zur Auswahl.

```{r Funktionen}

#Funktion zum Löschen aller Ausreißer, die nach IQR-1.5 Methode als Ausreißer gelten
remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...) # Vektor mit Quartilen 25% und 75% erstellen
  H <- 1.3 * IQR(x, na.rm = na.rm) #Antennenberechnung
  y <- x
  y[x < (qnt[1] - H)] <- NA #Untere Ausreißer entfernen
  y[x > (qnt[2] + H)] <- NA #Obere Ausreißer
  y
}

#Funktion für die Darstellung der Favstats für jede Spalte
multi.fun <- function(x) { 
      c(min = min(x), mean = mean(x), max = max(x), sd = sd(x), q1 = quantile(x, 0.25), med = median(x), q3 = quantile(x,0.75))
}
```

# Explorative Datenanalyse
## Rohdaten
Kurzer Überblick über die vorhandenen Daten in ihrer Rohform
```{r Rohdaten}
#inspect(test)
kable(head(test, n= 10)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
kable(apply(test, 2, multi.fun)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```
## Wichtige Metriken hinzufügen
Fügt die folgenden Metriken hinzu:
- Anzahl der bedachten Gruppen
```{r}
test <- test %>% mutate(gift.count = (X9.1*1) + (X9.2*1) +(X9.3*1) + (X9.4*1) + (X9.5*1) + (X9.6*1) + (X9.7*1) + (X9.8*1))
```

```{r}
#test <- test %>% mutate(gift.count = (X9.1*2.5) + (X9.2*2) + (X9.3*2) + (X9.4*0.5) + (X9.5*1) + (X9.6*1.5) + (X9.7*0.75) + (X9.8*0.5))
```

## Richtige Datentypen und Bezeichnungen
Kurzer Überblick über die Daten mit richtigen Spaltenbeschriftungen, um sie interpretieren zu können
```{r Datentypszuweisungen}
# cols <- c(#"X7.1","X7.2","X7.3","X7.4","X7.5","X7.6","X7.7",
  #"X9.1","X9.2","X9.3","X9.4","X9.5","X9.6","X9.7","X9.8",
#  "D2") #Auswahl der Spalten, die als Faktor interpretiert werden sollen
# test[cols] <- lapply(test[cols], factor) #Faktorspalten setzen
colnames(test) <- c("Beratung", "Angebote","Bequemlichkeit","Einkaufsatmosphaere","Marken","GPM","Naehe","Partner","Eltern","Verwandte","Kommilitonen","Kinder","Freunde","Arbeitskollegen","Soziale.Institutionen","Alter","Geschlecht","EKWert", "gift_count") #Spaltennamen setzen
kable(head(test, n= 10)) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) #Dataset erneut anschauen
```

## Ausreißer bereinigen
Ausreißer identifizieren und bereinigtes Dataset in "cl_test" speichern.
```{r Ausreißer}
col_EKW <- pull(test, EKWert) #Spalte extrahieren, um Ausreißer zu identifizieren
cl_test <- test %>% mutate("cleanedEKWert" = remove_outliers(col_EKW)) #Ausreißer nullen und in neues Datenset speichern
cl_test <- cl_test %>% filter(!is.na(cleanedEKWert)) #Datenset um Ausreißer bereinigen
cl_test <- subset(cl_test, select = -(cleanedEKWert))
kable(head(test, n= 10)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## Visualisierungen in Diagrammen
### Histogramm
```{r Histogramme}
gf_histogram(~ EKWert, data = test, binwidth = 50, center = 50, title = "Original - EK-Wert je Alter")
gf_histogram(~ EKWert, data = cl_test, binwidth = 50, center = 50, title = "Bereinigt - EK-Wert je Alter")
gf_point(EKWert ~ gift_count, data = cl_test, binwidth = 50, center = 50, title = "Ek-Wert je Geschenkanzahl")
```

### Punktwolken
```{r Punktwolken}
gf_point(EKWert ~ Alter, data= test, colour = ~ Geschlecht, title = "Original - EK-Wert je Alter")
gf_point(EKWert ~ Alter, data= cl_test, colour = ~ Geschlecht , title = "Bereinigt - EK-Wert je Alter")
gf_point(EKWert ~ gift_count, data = cl_test, colour = ~ Geschlecht, title = "Ek-Wert je Geschenkanzahl")
```

## Korrelationsanalysen
Korrelationsmatrix erstellen, um Abhängigkeiten zu identifizieren. Hier ist zu erkennen, dass der EKWert kaum Abhängigkeiten aufweist. Einzige kleine Ausnahme bildet die Güte der Produkte

```{r Korrelationsanalyse}
core_anal <- cl_test #%>% select("Beratung", "Angebote","Bequemlichkeit","Einkaufsatmosphaere","Marken","GPM","Naehe", "EKWert")
#Teil eines extrapakets aber sehr praktisch

invisible(rquery.cormat(core_anal))
```



## Lineare Modelle
```{r lineare Modelle}
lm_ekalter <- lm(EKWert ~ Alter, data = cl_test)
plotModel(lm_ekalter, title = "lm_ekalter")
summary(lm_ekalter)
lm_ekPartner <- lm(EKWert ~ Partner, data = cl_test)
plotModel(lm_ekPartner, title = "lm_ekPartner")
summary(lm_ekPartner)
lm_ekEltern <- lm(EKWert ~ Eltern, data = cl_test)
plotModel(lm_ekEltern, title = "lm_ekEltern")
summary(lm_ekEltern)
lm_ekVerwandte <- lm(EKWert ~ Verwandte, data = cl_test)
plotModel(lm_ekVerwandte, title = "lm_ekVerwandte")
summary(lm_ekVerwandte)
lm_ekKommilitonen <- lm(EKWert ~ Kommilitonen, data = cl_test)
plotModel(lm_ekKommilitonen, title = "lm_ekKommilitonen")
summary(lm_ekKommilitonen)
lm_ekKinder <- lm(EKWert ~ Kinder, data = cl_test)
plotModel(lm_ekKinder, title = "lm_ekKinder")
summary(lm_ekKinder)
lm_ekFreunde <- lm(EKWert ~ Freunde, data = cl_test)
plotModel(lm_ekFreunde, title = "lm_ekFreunde")
summary(lm_ekFreunde)
lm_ekArbeitskollegen <- lm(EKWert ~ Arbeitskollegen, data = cl_test)
plotModel(lm_ekArbeitskollegen, title = "lm_ekArbeitskollegen")
summary(lm_ekArbeitskollegen)
lm_ekSoziale.Institutionen <- lm(EKWert ~ Soziale.Institutionen, data = cl_test)
plotModel(lm_ekSoziale.Institutionen, title = "lm_ekSoziale.Institutionen")
summary(lm_ekSoziale.Institutionen)
lm_ekgift_count <- lm(EKWert ~ gift_count, data = cl_test)
plotModel(lm_ekgift_count, title = "lm_ekgift_count")
summary(lm_ekgift_count)

lm_ekBeratung <- lm(EKWert ~ Beratung, data = cl_test)
plotModel(lm_ekBeratung, title = "lm_ekBeratung")
summary(lm_ekBeratung)
lm_ekAngebote <- lm(EKWert ~ Angebote, data = cl_test)
plotModel(lm_ekAngebote, title = "lm_ekAngebote")
summary(lm_ekAngebote)
lm_ekBequemlichkeit <- lm(EKWert ~ Bequemlichkeit, data = cl_test)
plotModel(lm_ekBequemlichkeit, title = "lm_ekBequemlichkeit")
summary(lm_ekBequemlichkeit)
lm_ekEinkaufsatmosphaere <- lm(EKWert ~ Einkaufsatmosphaere, data = cl_test)
plotModel(lm_ekEinkaufsatmosphaere, title = "lm_ekEinkaufsatmosphaere")
summary(lm_ekEinkaufsatmosphaere)
lm_ekMarken <- lm(EKWert ~ Marken, data = cl_test)
plotModel(lm_ekMarken, title = "lm_ekMarken")
summary(lm_ekMarken)
lm_ekGPM <- lm(EKWert ~ GPM, data = cl_test)
plotModel(lm_ekGPM, title = "lm_ekGPM")
summary(lm_ekGPM)
lm_ekNaehe <- lm(EKWert ~ Naehe, data = cl_test)
plotModel(lm_ekNaehe, title = "lm_ekNaehe")
summary(lm_ekNaehe)
lm_ekGeschlecht <- lm(EKWert ~ Geschlecht, data = cl_test)
plotModel(lm_ekGeschlecht, title = "lm_ekGeschlecht")
summary(lm_ekGeschlecht)

glm.alle.dreierSterne <- glm(EKWert ~ Alter + Partner + Kinder + gift_count + GPM, data = cl_test)
plotModel(glm.alle.dreierSterne, title = "glm.alle.dreierSterne")
summary(glm.alle.dreierSterne)

glm.alle.groesser.gleich.zwei <- glm(EKWert ~ Alter + Partner + Kinder + gift_count + GPM + Soziale.Institutionen, data = cl_test)
plotModel(glm.alle.groesser.gleich.zwei, title = "glm.alle.groesser.gleich.zwei")
summary(glm.alle.groesser.gleich.zwei)

```

# Prediction
Anhand des erstellten Modells schätzen wir die Daten für das Anwendungs-Data-Set
```{r}
anwendung <- read.csv2("sources/Anwendungsdaten.csv")
anwendung <- anwendung %>% mutate(gift.count = (X9.1*1) + (X9.2*1) +(X9.3*1) + (X9.4*1) + (X9.5*1) + (X9.6*1) + (X9.7*1) + (X9.8*1))
colnames(anwendung) <- c("Beratung", "Angebote","Bequemlichkeit","Einkaufsatmosphaere","Marken","GPM","Naehe","Partner","Eltern","Verwandte","Kommilitonen","Kinder","Freunde","Arbeitskollegen","Soziale.Institutionen","Alter","Geschlecht","gift_count") #Spaltennamen setzen
ergglm <- predict.glm(glm.alle.dreierSterne, newdata = anwendung, interval="prediction")
favstats(ergglm)
plot(ergglm)
```

